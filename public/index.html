<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥–æ–ª–æ—Å—ñ–≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Highcharts -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/boost.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <script src="https://code.highcharts.com/modules/navigator.js"></script>
  <script src="https://code.highcharts.com/modules/range-selector.js"></script>

  <style>
    /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É */
    .history-icon { 
      cursor: pointer;
      transition: transform 0.2s ease;
      font-size: 1.5rem; /* –ó–±—ñ–ª—å—à–µ–Ω–æ —Ä–æ–∑–º—ñ—Ä –µ–º–æ–¥–∑—ñ */
    }
    .history-icon:hover {
      transform: scale(1.2);
    }
    .candidate-stats-icon { 
      cursor: pointer;
      transition: transform 0.2s ease;
      font-size: 1.5rem; /* –†–æ–∑–º—ñ—Ä –µ–º–æ–¥–∑—ñ –¥–ª—è –Ω–æ–≤–æ—ó —ñ–∫–æ–Ω–∫–∏ */
    }
    .candidate-stats-icon:hover {
      transform: scale(1.2);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 50;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(3px);
      overflow: auto;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 24px;
      border: none;
      width: 90%;
      max-width: 800px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .close {
      color: #666;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .close:hover { 
      color: #000;
    }
    .tag-block {
      display: inline-block;
      margin: 0.25rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tag-block:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }
    .flex-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      gap: 1.5rem;
    }
    .vote-bar {
      height: 8px;
      border-radius: 4px;
      background: #e2e8f0;
      overflow: hidden;
    }
    .vote-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
    }
    .stats-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .stats-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    /* –ü–æ–∫—Ä–∞—â–µ–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    .button-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      transition: all 0.3s ease;
    }

    .button-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .clickable-tag {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0.9;
    }
    .clickable-tag:hover {
      opacity: 1;
      transform: translateY(-1px);
    }

    /* –°—Ç–∏–ª—ñ –¥–ª—è –º—É–ª—å—Ç–∏–≤–∏–±–æ—Ä—É –∫–æ–∞–ª—ñ—Ü—ñ–π */
    .multiselect-container {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px;
      background-color: #fff;
    }
    .multiselect-container label {
      display: block;
      margin-bottom: 4px;
      cursor: pointer;
    }

    /* –°—Ç–∏–ª—ñ –¥–ª—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ */
    .table-row-hover {
      transition: background-color 0.2s ease;
    }
    .table-row-hover:hover {
      background-color: rgba(59, 130, 246, 0.05);
    }

    /* –°—Ç–∏–ª—ñ –¥–ª—è —Å–µ–ª–µ–∫—Ç—ñ–≤ –∑ –º—É–ª—å—Ç–∏–≤–∏–±–æ—Ä–æ–º */
    select[multiple] {
      height: auto;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö */
    @media (max-width: 768px) {
      #filtersSection {
        display: none;
      }
      #filtersSection.active {
        display: block;
      }
    }

    /* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è —Ç–∞–±–ª–∏—Ü—ñ */
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px 16px;
      border: 1px solid #e2e8f0;
    }
    th {
      background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
      color: white;
      text-transform: uppercase;
      font-size: 0.875rem;
      font-weight: 600;
    }
    td {
      font-size: 0.875rem;
    }

    /* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–æ–∫ –∑—ñ —Å—Ç–∏—Å–ª–æ—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ—é */
    .summary-statistics, .additional-statistics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .summary-card {
      background-color: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .summary-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .summary-icon {
      font-size: 3rem; /* –ó–±—ñ–ª—å—à–µ–Ω–æ —Ä–æ–∑–º—ñ—Ä –µ–º–æ–¥–∑—ñ */
      margin-bottom: 1rem;
    }
    .summary-content .count {
      font-size: 2rem;
      font-weight: bold;
      color: #1f2937;
    }
    .summary-content .count.secondary {
      font-size: 1.5rem;
      color: #4b5563;
    }
    .summary-content .label {
      font-size: 1rem;
      color: #6b7280;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 transition-colors duration-500">
  <!-- –í–∏–¥–∞–ª–µ–Ω–æ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π —Ö–µ–¥–µ—Ä -->

  <div class="container mx-auto px-4 py-6 flex-wrapper">
    <!-- Header Section -->
    <div class="flex-header">
      <h1 class="text-3xl md:text-5xl font-extrabold text-center text-gray-900 mb-6">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥–æ–ª–æ—Å—ñ–≤</h1>
      
      <div class="text-center text-sm text-gray-600 mb-6">
        <span>–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:</span> 
        <span id="lastUpdated" class="font-semibold text-gray-800">-</span>
      </div>

      <!-- –ó–∞–≥–∞–ª—å–Ω—ñ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
      <div class="summary-statistics">
        <!-- –ö–∞—Ä—Ç–∫–∞ –ó–∞–≥–∞–ª—å–Ω–æ—ó –ö—ñ–ª—å–∫–æ—Å—Ç—ñ –ì–æ–ª–æ—Å—ñ–≤ —Ç–∞ –£–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –ì–æ–ª–æ—Å—ñ–≤ -->
        <div class="summary-card">
          <div class="summary-icon">
            üìä
          </div>
          <div class="summary-content">
            <div class="count" id="cumulativeVotes">0</div>
            <div class="label">–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–ª–æ—Å—ñ–≤</div>
          </div>
        </div>
        
        <!-- –ö–∞—Ä—Ç–∫–∞ –ó–∞–≥–∞–ª—å–Ω–æ—ó –ö—ñ–ª—å–∫–æ—Å—Ç—ñ –ö–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤ -->
        <div class="summary-card">
          <div class="summary-icon">
            üë•
          </div>
          <div class="summary-content">
            <div class="count" id="totalCandidates">0</div>
            <div class="label">–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤</div>
          </div>
        </div>
        
        <!-- –ö–∞—Ä—Ç–∫–∞ –ó–∞–≥–∞–ª—å–Ω–æ—ó –ö—ñ–ª—å–∫–æ—Å—Ç—ñ –ö–æ–∞–ª—ñ—Ü—ñ–π -->
        <div class="summary-card">
          <div class="summary-icon">
            ü§ù
          </div>
          <div class="summary-content">
            <div class="count" id="totalCoalitions">0</div>
            <div class="label">–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ–∞–ª—ñ—Ü—ñ–π</div>
          </div>
        </div>
        
        <!-- –ö–∞—Ä—Ç–∫–∞ –°–µ—Ä–µ–¥–Ω—å–æ—ó –ö—ñ–ª—å–∫–æ—Å—Ç—ñ –ì–æ–ª–æ—Å—ñ–≤ -->
        <div class="summary-card">
          <div class="summary-icon">
            üìà
          </div>
          <div class="summary-content">
            <div class="count" id="averageVotes">0</div>
            <div class="label">–°–µ—Ä–µ–¥–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–ª–æ—Å—ñ–≤</div>
          </div>
        </div>
        
        <!-- –ö–∞—Ä—Ç–∫–∞ –ù–∞–π–ø–æ–ø—É–ª—è—Ä–Ω—ñ—à–æ—ó –ö–æ–∞–ª—ñ—Ü—ñ—ó -->
        <div class="summary-card">
          <div class="summary-icon">
            üèÜ
          </div>
          <div class="summary-content">
            <div class="count" id="topCoalition">-</div>
            <div class="label">–ù–∞–π–ø–æ–ø—É–ª—è—Ä–Ω—ñ—à–∞ –∫–æ–∞–ª—ñ—Ü—ñ—è</div>
          </div>
        </div>
      </div>

      <!-- –î–æ–¥–∞—Ç–∫–æ–≤—ñ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
      <div class="additional-statistics">
        <!-- –ö–∞—Ä—Ç–∫–∞ –°–µ—Ä–µ–¥–Ω—ñ–π –í—ñ–¥—Å–æ—Ç–æ–∫ –ì–æ–ª–æ—Å—ñ–≤ –Ω–∞ –ö–∞–Ω–¥–∏–¥–∞—Ç–∞ -->
        <div class="summary-card">
          <div class="summary-icon">
            üìä
          </div>
          <div class="summary-content">
            <div class="count" id="averagePercentageVotes">0%</div>
            <div class="label">–°–µ—Ä–µ–¥–Ω—ñ–π –≤—ñ–¥—Å–æ—Ç–æ–∫ –≥–æ–ª–æ—Å—ñ–≤ –Ω–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</div>
          </div>
        </div>
        
        <!-- –ö–∞—Ä—Ç–∫–∞ –£–Ω—ñ–∫–∞–ª—å–Ω—ñ –í–∏–±–æ—Ä—Ü—ñ -->
        <div class="summary-card">
          <div class="summary-icon">
            üë§
          </div>
          <div class="summary-content">
            <div class="count" id="uniqueVoters">0</div>
            <div class="label">–£–Ω—ñ–∫–∞–ª—å–Ω—ñ –≤–∏–±–æ—Ä—Ü—ñ</div>
          </div>
        </div>

        <!-- –ö–∞—Ä—Ç–∫–∞ –†–æ–∑–ø–æ–¥—ñ–ª –ì–æ–ª–æ—Å—ñ–≤ –∑–∞ –ö–æ–∞–ª—ñ—Ü—ñ—è–º–∏ -->
        <div class="summary-card">
          <div class="summary-icon">
            üìä
          </div>
          <div class="summary-content">
            <div class="count" id="votesByCoalition">0%</div>
            <div class="label">–†–æ–∑–ø–æ–¥—ñ–ª –≥–æ–ª–æ—Å—ñ–≤ –∑–∞ –∫–æ–∞–ª—ñ—Ü—ñ—è–º–∏</div>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <!-- –í–∏–¥–∞–ª–µ–Ω–æ –∫–Ω–æ–ø–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ -->

        <input 
          type="text" 
          id="searchInput" 
          placeholder="üîç –ü–æ—à—É–∫ –ø–æ —ñ–º–µ–Ω—ñ..." 
          class="border rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring focus:border-blue-500"
        >
        <select 
          id="sortSelect" 
          class="border rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring focus:border-blue-500"
        >
          <option value="votes">–ó–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é –≥–æ–ª–æ—Å—ñ–≤</option>
          <option value="id">–ó–∞ ID</option>
          <option value="name">–ó–∞ —ñ–º'—è–º</option>
        </select>
        <button 
          id="refreshBtn" 
          class="button-primary text-white px-6 py-2 rounded-lg shadow-md hover:bg-blue-500 transition-all w-full"
        >
          üîÑ –û–Ω–æ–≤–∏—Ç–∏
        </button>
        <button 
          id="toggleFiltersBtn" 
          class="bg-gray-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-gray-500 transition-all w-full md:hidden"
        >
          –§—ñ–ª—å—Ç—Ä–∏
        </button>
      </div>

      <!-- Filters (Visible on desktop, collapsible on mobile) -->
      <div id="filtersSection" class="hidden md:block">
        <!-- Tags Filter -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
          <h2 class="text-lg font-semibold mb-3">–§—ñ–ª—å—Ç—Ä –∑–∞ –∫–æ–∞–ª—ñ—Ü—ñ—è–º–∏:</h2>
          <div id="tagsMap" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-content">
      <!-- Desktop Table -->
      <div class="hidden md:block overflow-x-auto bg-white shadow-md rounded-lg table-container">
        <table class="w-full border-collapse text-left">
          <!-- Table Header -->
          <thead>
            <tr>
              <th class="px-6 py-3">ID</th>
              <th class="px-6 py-3">–ö–∞–Ω–¥–∏–¥–∞—Ç</th>
              <th class="px-6 py-3">–ì–û</th>
              <th class="px-6 py-3">–ì–æ–ª–æ—Å–∏</th>
              <th class="px-6 py-3">–ö–æ–∞–ª—ñ—Ü—ñ—ó</th>
              <th class="px-6 py-3">–Ü—Å—Ç–æ—Ä—ñ—è</th>
              <th class="px-6 py-3">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th> <!-- –ù–æ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ -->
            </tr>
          </thead>
          <tbody id="candidatesTableBody" class="text-gray-700 text-sm"></tbody>
        </table>
      </div>

      <!-- Mobile Cards (–∑–∞–ª–∏—à–∞—î–º–æ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤) -->
      <div id="candidatesMobileView" class="md:hidden space-y-4"></div>
    </div>

    <!-- Chart Section -->
    <div class="flex-footer mt-6">
      <div class="bg-white rounded-lg shadow-md p-4">
        <div class="flex flex-col md:flex-row items-center justify-between mb-4 gap-4">
          <h2 class="text-lg font-semibold">–ì—Ä–∞—Ñ—ñ–∫ –≥–æ–ª–æ—Å—ñ–≤:</h2>
          <div class="flex flex-col md:flex-row items-center gap-2 w-full md:w-auto">
            <label for="coalitionSelect" class="text-sm font-medium">–í–∏–±–µ—Ä—ñ—Ç—å –∫–æ–∞–ª—ñ—Ü—ñ—ó:</label>
            <select 
              id="coalitionSelect" 
              class="border rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring focus:border-blue-500"
              multiple
              size="3"
            >
              <!-- –û–ø—Ü—ñ—ó –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
            </select>
          </div>
        </div>
        <div id="votesChart" style="height: 600px; width: 100%;"></div>
      </div>
    </div>
  </div>

  <!-- Vote History Modal -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 class="text-xl font-semibold mb-4">–Ü—Å—Ç–æ—Ä—ñ—è –≥–æ–ª–æ—Å—ñ–≤</h2>
      <div id="historyContent" class="space-y-2"></div>
    </div>
  </div>

  <!-- Candidate Statistics Modal -->
  <div id="candidateStatsModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 class="text-xl font-semibold mb-4">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</h2>
      <div id="candidateStatsContent" class="space-y-2"></div>
    </div>
  </div>

  <script>
    const CONFIG = {
      tags: {
        "–î–µ–º–°–æ–∫–∏—Ä–∞ —Ç–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∏": [1, 2, 3, 5, 7, 8, 22, 23, 24, 31, 32, 33, 38, 39, 40],
        "–ö–æ–∞–ª—ñ—Ü—ñ—è –Ø—Ä–æ–≤–æ—ó": [37, 36, 35, 27, 26, 25, 17, 18, 10, 11],
        "–°—Ç–∞–ª–∫–µ—Ä—è—Ç–∞": [14, 19, 13, 21, 20]
      },
      tagColors: {
        "–î–µ–º–°–æ–∫–∏—Ä–∞ —Ç–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∏": "bg-red-500 text-white",
        "–ö–æ–∞–ª—ñ—Ü—ñ—è –Ø—Ä–æ–≤–æ—ó": "bg-blue-500 text-white",
        "–°—Ç–∞–ª–∫–µ—Ä—è—Ç–∞": "bg-green-500 text-white"
      },
      candidateColors: {
        1: '#FF6B6B', 2: '#4ECDC4', 3: '#45B7D1', 4: '#96CEB4', 5: '#FFEEAD',
        6: '#D4A5A5', 7: '#9370DB', 8: '#20B2AA', 9: '#FFB6C1', 10: '#87CEEB',
        11: '#FFA07A', 12: '#98FB98', 13: '#DDA0DD', 14: '#F0E68C', 15: '#E6E6FA',
        16: '#FF69B4', 17: '#CD853F', 18: '#BA55D3', 19: '#32CD32', 20: '#FF4500',
        21: '#4682B4', 22: '#D8BFD8', 23: '#DEB887', 24: '#5F9EA0', 25: '#FFC0CB',
        26: '#FFD700', 27: '#ADFF2F', 28: '#4B0082', 29: '#F0E68C', 30: '#E6E6FA',
        31: '#7FFFD4', 32: '#FF69B4', 33: '#8B4513', 34: '#6A5ACD', 35: '#D2691E',
        36: '#FF4500', 37: '#2E8B57', 38: '#D2B48C', 39: '#DA70D6', 40: '#48D1CC'
      },
      updateInterval: 10 * 1000 // 10 —Å–µ–∫—É–Ω–¥
    };

    let state = {
      allCandidates: [],
      topCandidates: [],
      voteTimestamps: [],
      selectedTags: [],
      voteHistoryData: {},
      chart: null,
      uniqueVoters: 0
    };

    // Utility Functions
    const formatDate = date => new Date(date).toLocaleString('uk-UA');
    const formatTime = date => new Date(date).toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
    const getRandomColor = () => '#' + Math.floor(Math.random()*16777215).toString(16);

    // Data Fetching
    async function fetchStats() {
      showLoading();
      try {
        const res = await fetch('/api/stats'); // –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ –≤–∞—à API-–µ–Ω–¥–ø–æ—ñ–Ω—Ç
        const data = await res.json();

        state.allCandidates = data.candidates.map(candidate => ({
          ...candidate,
          tags: Object.entries(CONFIG.tags)
            .filter(([_, ids]) => ids.includes(Number(candidate.id)))
            .map(([tagName]) => tagName)
        }));

        state.voteTimestamps = data.voteTimestamps;
        state.voteHistoryData = {};
        state.allCandidates.forEach(candidate => {
          state.voteHistoryData[candidate.id] = candidate.voteHistory;
        });

        state.topCandidates = state.allCandidates
          .sort((a, b) => b.votes - a.votes)
          .slice(0, 15)
          .map(c => Number(c.id));

        state.uniqueVoters = data.uniqueVoters;

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫—É–º—É–ª—è—Ç–∏–≤–Ω–∏—Ö –≥–æ–ª–æ—Å—ñ–≤
        Object.entries(state.voteHistoryData).forEach(([candidateId, history]) => {
          let previous = 0;
          Object.entries(history).forEach(([timestamp, data]) => {
            if (data.cumulativeVotes < previous) {
              console.warn(`–ö—É–º—É–ª—è—Ç–∏–≤–Ω—ñ –≥–æ–ª–æ—Å–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ ${candidateId} –∑–º–µ–Ω—à–∏–ª–∏—Å—è –Ω–∞ ${timestamp}`);
            }
            previous = data.cumulativeVotes;
          });
        });

        updateUI();
        document.getElementById('lastUpdated').textContent = formatDate(data.timestamp);
      } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:', err);
        alert('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –¥–∞–Ω–∏—Ö.');
      } finally {
        hideLoading();
      }
    }

    // UI Updates
    function updateUI() {
      renderTagsMap();
      renderSummaryStatistics();
      renderAdditionalStatistics();
      renderCandidatesTable();
      renderMobileCards();
      renderVoteChart();
    }

    function renderTagsMap() {
      const tagsHtml = Object.keys(CONFIG.tags).map(tag => `
        <span 
          class="px-4 py-2 rounded-full tag-block ${CONFIG.tagColors[tag]} 
          ${state.selectedTags.includes(tag) ? 'ring-2 ring-offset-2 ring-blue-500' : ''}"
          onclick="toggleTag('${tag}')">
          ${tag}
          <span class="ml-2 text-sm opacity-75">(${CONFIG.tags[tag].length})</span>
        </span>
      `).join('');

      document.getElementById('tagsMap').innerHTML = tagsHtml;
    }

    function renderSummaryStatistics() {
      const totalVotes = state.allCandidates.reduce((sum, candidate) => sum + candidate.votes, 0);
      const totalCandidates = state.allCandidates.length;
      const totalCoalitions = new Set(state.allCandidates.flatMap(c => c.tags)).size;
      const averageVotes = (totalVotes / (totalCandidates || 1)).toFixed(2);
      const topCoalition = getTopCoalition();

      document.getElementById('cumulativeVotes').textContent = totalVotes.toLocaleString('uk-UA');
      document.getElementById('totalCandidates').textContent = totalCandidates;
      document.getElementById('totalCoalitions').textContent = totalCoalitions;
      document.getElementById('averageVotes').textContent = averageVotes.toLocaleString('uk-UA');
      document.getElementById('topCoalition').textContent = topCoalition || '-';
    }

    function renderAdditionalStatistics() {
      const totalVotes = state.allCandidates.reduce((sum, candidate) => sum + candidate.votes, 0);
      const totalCandidates = state.allCandidates.length;
      const averagePercentageVotes = ((totalVotes / (totalCandidates || 1)) / totalVotes * 100).toFixed(2) + '%';
      
      // –†–æ–∑–ø–æ–¥—ñ–ª –≥–æ–ª–æ—Å—ñ–≤ –∑–∞ –∫–æ–∞–ª—ñ—Ü—ñ—è–º–∏ - –ø—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ —Ü–µ –∑–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–ª–æ—Å—ñ–≤ –ø–æ–¥—ñ–ª–µ–Ω–∞ –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ–∞–ª—ñ—Ü—ñ–π
      const totalCoalitions = new Set(state.allCandidates.flatMap(c => c.tags)).size;
      const votesByCoalition = totalCoalitions > 0 ? ((totalVotes / totalCoalitions) / totalVotes * 100).toFixed(2) + '%' : '0%';

      document.getElementById('averagePercentageVotes').textContent = averagePercentageVotes;
      document.getElementById('uniqueVoters').textContent = state.uniqueVoters.toLocaleString('uk-UA');
      document.getElementById('votesByCoalition').textContent = votesByCoalition;
    }

    function getTopCoalition() {
      const coalitionVotes = {};

      state.allCandidates.forEach(candidate => {
        candidate.tags.forEach(tag => {
          if (!coalitionVotes[tag]) coalitionVotes[tag] = 0;
          coalitionVotes[tag] += candidate.votes;
        });
      });

      let top = null;
      let maxVotes = -1;
      Object.entries(coalitionVotes).forEach(([tag, votes]) => {
        if (votes > maxVotes) {
          maxVotes = votes;
          top = tag;
        }
      });

      return top;
    }

    function renderCandidatesTable() {
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();
      const sortType = document.getElementById('sortSelect').value;

      let filtered = state.allCandidates.filter(c => 
        c.name.toLowerCase().includes(searchQuery) && 
        (state.selectedTags.length === 0 || c.tags.some(tag => state.selectedTags.includes(tag)))
      );

      filtered.sort((a, b) => {
        switch (sortType) {
          case 'votes': return b.votes - a.votes;
          case 'id': return Number(a.id) - Number(b.id);
          case 'name': return a.name.localeCompare(b.name);
          default: return 0;
        }
      });

      const maxVotes = Math.max(...state.allCandidates.map(c => c.votes), 1); // –£–Ω–∏–∫–Ω–µ–Ω–Ω—è –¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ 0

      const rowsHtml = filtered.map(c => {
        const isTop = state.topCandidates.includes(Number(c.id));
        const votePercentage = ((c.votes / maxVotes) * 100).toFixed(2);

        return `
          <tr class="${isTop ? 'bg-blue-50' : 'table-row-hover'}">
            <td class="px-6 py-3">${c.id}</td>
            <td class="px-6 py-3 font-medium">${c.name}</td>
            <td class="px-6 py-3">${c.ngo || '-'}</td>
            <td class="px-6 py-3">
              <div class="flex items-center gap-3">
                <span class="font-medium">${c.votes.toLocaleString('uk-UA')}</span>
                <div class="flex-1">
                  <div class="vote-bar">
                    <div class="vote-bar-fill" style="width: ${votePercentage}%"></div>
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-3">
              <div class="flex flex-wrap gap-1">
                ${c.tags.map(tag => `
                  <span 
                    onclick="toggleTag('${tag}')"
                    class="clickable-tag ${CONFIG.tagColors[tag]}"
                  >${tag}</span>
                `).join('')}
              </div>
            </td>
            <td class="px-6 py-3">
              <button 
                onclick="showVoteHistory(${c.id})"
                class="p-2 hover:bg-gray-100 rounded-full transition-colors history-icon"
                title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –≥–æ–ª–æ—Å—ñ–≤"
              >
                üìú
              </button>
            </td>
            <td class="px-6 py-3">
              <button 
                onclick="showCandidateStats(${c.id})"
                class="p-2 hover:bg-gray-100 rounded-full transition-colors candidate-stats-icon"
                title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–Ω–¥–∏–¥–∞—Ç–∞"
              >
                üìä
              </button>
            </td>
          </tr>
        `;
      }).join('');

      document.getElementById('candidatesTableBody').innerHTML = rowsHtml;
    }

    function renderMobileCards() {
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();
      const sortType = document.getElementById('sortSelect').value;

      let filtered = state.allCandidates.filter(c => 
        c.name.toLowerCase().includes(searchQuery) && 
        (state.selectedTags.length === 0 || c.tags.some(tag => state.selectedTags.includes(tag)))
      );

      filtered.sort((a, b) => {
        switch (sortType) {
          case 'votes': return b.votes - a.votes;
          case 'id': return Number(a.id) - Number(b.id);
          case 'name': return a.name.localeCompare(b.name);
          default: return 0;
        }
      });

      const maxVotes = Math.max(...state.allCandidates.map(c => c.votes), 1); // –£–Ω–∏–∫–Ω–µ–Ω–Ω—è –¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ 0

      const cardsHtml = filtered.map(c => {
        const isTop = state.topCandidates.includes(Number(c.id));
        const votePercentage = ((c.votes / maxVotes) * 100).toFixed(2);

        return `
          <div class="stats-card p-4 ${isTop ? 'border-l-4 border-blue-400' : ''} bg-white">
            <div class="flex justify-between items-start mb-3">
              <div class="font-bold text-lg text-gray-900">${c.name}</div>
              <div class="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded">ID: ${c.id}</div>
            </div>
            <div class="text-sm text-gray-600 mb-3">${c.ngo || '-'}</div>
            <div class="mb-4">
              <div class="font-semibold mb-2 text-gray-900">${c.votes.toLocaleString('uk-UA')} –≥–æ–ª–æ—Å—ñ–≤</div>
              <div class="vote-bar">
                <div class="vote-bar-fill" style="width: ${votePercentage}%"></div>
              </div>
            </div>
            <div class="flex flex-wrap gap-1 mb-3">
              ${c.tags.map(tag => `
                <span 
                  onclick="toggleTag('${tag}')"
                  class="clickable-tag ${CONFIG.tagColors[tag]}"
                >${tag}</span>
              `).join('')}
            </div>
            <div class="flex justify-between">
              <button 
                onclick="showVoteHistory(${c.id})"
                class="py-2 px-4 bg-gray-50 hover:bg-gray-100 rounded-lg text-center text-gray-600 transition-colors flex items-center"
              >
                üìú –Ü—Å—Ç–æ—Ä—ñ—è
              </button>
              <button 
                onclick="showCandidateStats(${c.id})"
                class="py-2 px-4 bg-gray-50 hover:bg-gray-100 rounded-lg text-center text-gray-600 transition-colors flex items-center"
              >
                üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
              </button>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('candidatesMobileView').innerHTML = cardsHtml;
    }

    // Vote History Modal Management
    let voteHistoryCache = new Map();

    function showVoteHistory(candidateId) {
      const modal = document.getElementById('historyModal');
      
      if (voteHistoryCache.has(candidateId)) {
        document.getElementById('historyContent').innerHTML = voteHistoryCache.get(candidateId);
        modal.style.display = "block";
        return;
      }

      const candidate = state.allCandidates.find(c => c.id == candidateId);
      const history = state.voteHistoryData[candidateId];

      const historyContent = Object.entries(history)
        .sort(([a], [b]) => new Date(a) - new Date(b)) // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∑–∞ —á–∞—Å–æ–º
        .map(([timestamp, data]) => `
          <div class="py-2 border-b last:border-0">
            <div class="font-medium text-gray-900">${formatTime(timestamp)}</div>
            <div class="text-sm text-gray-600">
              –ì–æ–ª–æ—Å—ñ–≤: ${data.votes.toLocaleString('uk-UA')} 
              <span class="mx-2">‚Ä¢</span>
              –í—Å—å–æ–≥–æ: ${data.cumulativeVotes.toLocaleString('uk-UA')}
            </div>
          </div>
        `).join('');

      const content = `
        <div class="mb-4">
          <h3 class="font-bold text-lg text-gray-900">${candidate.name}</h3>
          <p class="text-gray-600">ID: ${candidate.id}</p>
        </div>
        <div class="divide-y">${historyContent}</div>
      `;

      voteHistoryCache.set(candidateId, content);
      
      document.getElementById('historyContent').innerHTML = content;
      modal.style.display = "block";
    }

    // Candidate Statistics Modal Management
    let candidateStatsCache = new Map();

    function showCandidateStats(candidateId) {
      const modal = document.getElementById('candidateStatsModal');
      
      if (candidateStatsCache.has(candidateId)) {
        document.getElementById('candidateStatsContent').innerHTML = candidateStatsCache.get(candidateId);
        modal.style.display = "block";
        return;
      }

      const candidate = state.allCandidates.find(c => c.id == candidateId);
      const history = state.voteHistoryData[candidateId];

      // –û–±—á–∏—Å–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫
      const totalVotes = candidate.votes;
      const averageVoteTime = calculateAverageVoteTime(history);
      const peakVote = getPeakVote(history);

      const statsContent = `
        <div class="mb-4">
          <h3 class="font-bold text-lg text-gray-900">${candidate.name}</h3>
          <p class="text-gray-600">ID: ${candidate.id}</p>
        </div>
        <div class="space-y-2">
          <div class="py-2">
            <span class="font-medium text-gray-900">–ó–∞–≥–∞–ª—å–Ω—ñ –≥–æ–ª–æ—Å–∏:</span> ${totalVotes.toLocaleString('uk-UA')}
          </div>
          <div class="py-2">
            <span class="font-medium text-gray-900">–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≥–æ–ª–æ—Å—É:</span> ${averageVoteTime} —Ö–≤–∏–ª–∏–Ω
          </div>
          <div class="py-2">
            <span class="font-medium text-gray-900">–ü—ñ–∫ –≥–æ–ª–æ—Å—ñ–≤:</span> ${peakVote.votes.toLocaleString('uk-UA')} –≥–æ–ª–æ—Å—ñ–≤ –æ ${formatTime(peakVote.timestamp)}
          </div>
        </div>
      `;

      candidateStatsCache.set(candidateId, statsContent);
      
      document.getElementById('candidateStatsContent').innerHTML = statsContent;
      modal.style.display = "block";
    }

    // Helper Functions for Candidate Stats
    function calculateAverageVoteTime(history) {
      const timestamps = Object.keys(history).sort((a, b) => new Date(a) - new Date(b));
      if (timestamps.length < 2) return 'N/A';
      
      let totalTime = 0;
      for (let i = 1; i < timestamps.length; i++) {
        const prev = new Date(timestamps[i-1]);
        const current = new Date(timestamps[i]);
        const diff = (current - prev) / (1000 * 60); // –í —Ö–≤–∏–ª–∏–Ω–∞—Ö
        totalTime += diff;
      }
      const average = (totalTime / (timestamps.length - 1)).toFixed(2);
      return average;
    }

    function getPeakVote(history) {
      let peak = { votes: 0, timestamp: null };
      Object.entries(history).forEach(([timestamp, data]) => {
        if (data.votes > peak.votes) {
          peak = { votes: data.votes, timestamp };
        }
      });
      return peak;
    }

    // Toggle Tag Selection
    function toggleTag(tag) {
      const index = state.selectedTags.indexOf(tag);
      if (index > -1) {
        state.selectedTags.splice(index, 1);
      } else {
        state.selectedTags.push(tag);
      }
      renderTagsMap();
      renderSummaryStatistics();
      renderAdditionalStatistics();
      renderCandidatesTable();
      renderMobileCards();
      renderVoteChart();
    }

    // Chart Rendering with Highcharts
    function renderVoteChart() {
      const selectedCoalitions = Array.from(document.getElementById('coalitionSelect').selectedOptions).map(option => option.value);
      state.selectedTagsForChart = selectedCoalitions;
      
      const chartData = prepareChartData();

      if (state.chart) {
        state.chart.destroy();
      }

      state.chart = Highcharts.chart('votesChart', {
        chart: {
          type: 'line',
          zoomType: 'x',
          panning: true,
          panKey: 'shift',
          height: 600,
          events: {
            load: function () {
              // Initial highlight
            }
          },
          zoomBySingleTouch: true,
        },
        title: {
          text: '–ì—Ä–∞—Ñ—ñ–∫ –≥–æ–ª–æ—Å—ñ–≤'
        },
        subtitle: {
          text: '–î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ'
        },
        xAxis: {
          type: 'datetime',
          title: {
            text: '–ß–∞—Å'
          },
          labels: {
            format: '{value:%d.%m.%Y %H:%M}',
            style: {
              fontSize: '11px',
              fontFamily: 'Inter, sans-serif'
            }
          }
        },
        yAxis: {
          title: {
            text: '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–ª–æ—Å—ñ–≤'
          },
          labels: {
            formatter: function () {
              return this.value.toLocaleString('uk-UA');
            }
          }
        },
        tooltip: {
          shared: false,
          formatter: function () {
            return `<b>${Highcharts.dateFormat('%d.%m.%Y %H:%M', this.x)}</b><br/><span style="color:${this.point.color}">\u25CF</span> ${this.series.name}: ${this.y.toLocaleString('uk-UA')} –≥–æ–ª–æ—Å—ñ–≤`;
          }
        },
        plotOptions: {
          series: {
            cursor: 'pointer',
            states: {
              hover: {
                enabled: true,
                lineWidth: 3
              }
            },
            marker: {
              enabled: true,
              radius: 4,
              symbol: 'circle'
            },
            events: {
              click: function (event) {
                alert(`–ö–∞–Ω–¥–∏–¥–∞—Ç: ${this.name}\n–ì–æ–ª–æ—Å–∏: ${event.point.y.toLocaleString('uk-UA')}`);
              },
              mouseOver: function () {
                this.chart.series.forEach(function (s) {
                  if (s !== this) {
                    s.update({ opacity: 0.2 }, false);
                  }
                }, this);
                this.update({ opacity: 1 }, false);
                this.chart.redraw();
              },
              mouseOut: function () {
                this.chart.series.forEach(function (s) {
                  s.update({ opacity: 1 }, false);
                });
                this.chart.redraw();
              }
            }
          },
          line: {
            marker: {
              enabled: true
            }
          }
        },
        series: chartData.datasets.map(dataset => ({
          name: dataset.label,
          data: dataset.data.map(point => [point.x, point.y]),
          color: dataset.borderColor,
          lineWidth: 2.5,
          marker: {
            radius: 4,
            symbol: 'circle'
          }
        })),
        legend: {
          enabled: true,
          layout: 'vertical',
          align: 'right',
          verticalAlign: 'middle',
          maxHeight: 400,
          itemStyle: {
            fontSize: '10px',
            fontFamily: 'Inter, sans-serif'
          }
        },
        credits: {
          enabled: false
        },
        boost: {
          useGPUTranslations: true
        },
        navigator: {
          enabled: true,
          height: 20,
          margin: 10
        },
        rangeSelector: {
          enabled: true,
          buttons: [{
            type: 'day',
            count: 7,
            text: '7 –¥–Ω—ñ–≤'
          }, {
            type: 'month',
            count: 1,
            text: '1 –º—ñ—Å—è—Ü—å'
          }, {
            type: 'all',
            text: '–í—Å—ñ'
          }],
          selected: 2
        },
        exporting: {
          buttons: {
            customButton: {
              text: '–°–∫–∏–Ω—É—Ç–∏ –∑—É–º',
              onclick: function () {
                this.xAxis[0].setExtremes();
              },
              align: 'right',
              verticalAlign: 'top',
              y: 0
            }
          }
        },
        responsive: {
          rules: [{
            condition: {
              maxWidth: 800
            },
            chartOptions: {
              legend: {
                layout: 'horizontal',
                align: 'center',
                verticalAlign: 'bottom'
              }
            }
          }]
        }
      });
    }

    // Prepare Data for Highcharts
    function prepareChartData() {
      const datasets = [];
      const allTimestamps = new Set();
      const timestampValues = {};

      Object.entries(state.voteHistoryData).forEach(([candidateId, history]) => {
        Object.entries(history).forEach(([timestamp, data]) => {
          allTimestamps.add(timestamp);
          if (!timestampValues[timestamp]) {
            timestampValues[timestamp] = {};
          }
          // –ó–∞–±–µ–∑–ø–µ—á—Ç–µ, —â–æ cumulativeVotes –Ω–µ –∑–º–µ–Ω—à—É—é—Ç—å—Å—è
          if (!timestampValues[timestamp][candidateId] || data.cumulativeVotes >= timestampValues[timestamp][candidateId]) {
            timestampValues[timestamp][candidateId] = data.cumulativeVotes;
          }
        });
      });

      const sortedTimestamps = Array.from(allTimestamps).sort((a, b) => new Date(a) - new Date(b));

      state.allCandidates.forEach(candidate => {
        const belongsToSelectedCoalition = state.selectedTagsForChart.length === 0 || candidate.tags.some(tag => state.selectedTagsForChart.includes(tag));

        if (belongsToSelectedCoalition) {
          let lastCumulative = 0;
          const candidateData = sortedTimestamps.map(timestamp => {
            const current = timestampValues[timestamp]?.[candidate.id] || lastCumulative;
            lastCumulative = current;
            return {
              x: new Date(timestamp).getTime(),
              y: current
            };
          });

          datasets.push({
            label: `${candidate.name}`,
            data: candidateData,
            borderColor: CONFIG.candidateColors[candidate.id] || getRandomColor(),
            boostThreshold: 1
          });
        }
      });

      return {
        labels: sortedTimestamps.map(timestamp => new Date(timestamp).getTime()),
        datasets: datasets
      };
    }

    // Event Listeners and Initialization
    document.addEventListener('DOMContentLoaded', () => {
      // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤–∏–±–æ—Ä—É –∫–æ–∞–ª—ñ—Ü—ñ–π
      document.getElementById('coalitionSelect').innerHTML = `
        ${Object.keys(CONFIG.tags).map(tag => `<option value="${tag}">${tag}</option>`).join('')}
      `;

      // –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö
      document.getElementById('toggleFiltersBtn').addEventListener('click', () => {
        const filtersSection = document.getElementById('filtersSection');
        if (filtersSection.classList.contains('hidden')) {
          filtersSection.classList.remove('hidden');
          filtersSection.classList.add('active');
        } else {
          filtersSection.classList.add('hidden');
          filtersSection.classList.remove('active');
        }
      });

      // –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω
      const historyModal = document.getElementById('historyModal');
      const candidateStatsModal = document.getElementById('candidateStatsModal');
      const closeModal = () => { 
        historyModal.style.display = "none"; 
        candidateStatsModal.style.display = "none"; 
      };
      document.querySelectorAll('.close').forEach(elem => {
        elem.addEventListener('click', closeModal);
      });
      window.addEventListener('click', (event) => {
        if (event.target === historyModal || event.target === candidateStatsModal) {
          closeModal();
        }
      });

      // –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ —Ç–∞–±–ª–∏—Ü—ñ
      const debouncedRenderTable = debounce(renderCandidatesTable, 250);
      document.getElementById('searchInput').addEventListener('input', () => {
        debouncedRenderTable();
      });
      document.getElementById('sortSelect').addEventListener('change', () => {
        debouncedRenderTable();
      });

      // –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –≥—Ä–∞—Ñ—ñ–∫—É
      document.getElementById('coalitionSelect').addEventListener('change', () => {
        const selectedOptions = Array.from(document.getElementById('coalitionSelect').selectedOptions).map(option => option.value);
        state.selectedTagsForChart = selectedOptions;
        renderVoteChart();
      });

      // –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
      document.getElementById('refreshBtn').addEventListener('click', fetchStats);

      // –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
      fetchStats();

      // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
      setInterval(() => {
        fetchStats().catch(console.error);
      }, CONFIG.updateInterval);
    });

    // Utility debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Loading Indicator
    function showLoading() {
      if (!document.getElementById('loadingSpinner')) {
        const loader = document.createElement('div');
        loader.className = 'loading-spinner';
        loader.id = 'loadingSpinner';
        document.body.appendChild(loader);
      }
    }

    function hideLoading() {
      const loader = document.getElementById('loadingSpinner');
      if (loader) {
        loader.remove();
      }
    }
  </script>
</body>
</html>
